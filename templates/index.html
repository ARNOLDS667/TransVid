<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TransVid Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
</head>
<body>
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="spinner"></div>
    <div class="loading-text">Chargement en cours...</div>
</div>
<div class="container">
    <h1>ğŸ§ TransVid Pro</h1>
    <p>Traduisez et doublez vos vidÃ©os YouTube automatiquement en franÃ§ais.</p>

    <form id="videoForm">
        <input type="text" name="youtube_url" placeholder="Entrez lâ€™URL YouTube ici" required>

        <label for="quality">QualitÃ© vidÃ©o :</label>
        <select name="quality" id="quality">
            <option value="best">Meilleure (par dÃ©faut)</option>
            <option value="medium">Moyenne (â‰¤720p) â€” plus rapide</option>
            <option value="low">Faible (â‰¤360p) â€” plus rapide et lÃ©ger</option>
        </select>

        <!-- Option aria2 retirÃ©e : tÃ©lÃ©chargement gÃ©rÃ© cÃ´tÃ© serveur automatiquement -->

        <!-- Suppression automatique des fichiers gÃ©rÃ©e cÃ´tÃ© serveur -->

        <button type="submit">Lancer la traduction & doublage</button>
    </form>

    <div id="logs" class="logs"></div>

    <div id="progressBarContainer">
        <div id="progressBar"></div>
    </div>

    <div id="downloadLink" class="download"></div>
    <!-- Le bouton de purge a Ã©tÃ© retirÃ© (nettoyage automatique) -->
    <div id="toast" style="position:fixed;bottom:20px;right:20px;display:none;background:#333;color:#fff;padding:12px 18px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.15);z-index:9999;"></div>
</div>

<script>
const socket = io();
const form = document.getElementById("videoForm");
const logs = document.getElementById("logs");
const progressBar = document.getElementById("progressBar");
const downloadLink = document.getElementById("downloadLink");
const toast = document.getElementById('toast');

form.addEventListener("submit", e=>{
    e.preventDefault();
    downloadLink.innerHTML = "";
    logs.innerHTML = "";
    progressBar.style.width = "0%";

    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = loadingOverlay.querySelector('.loading-text');
    loadingText.textContent = 'DÃ©but du tÃ©lÃ©chargement...';
    // show a blocking overlay immediately so user gets instant feedback
    loadingOverlay.style.display = 'flex';

    // disable submit while processing
    const submitBtn = form.querySelector('button[type=submit]');
    submitBtn.disabled = true;

    // If we don't hear any socket activity in this time, assume something went wrong
    let activityTimeout = setTimeout(()=>{
        loadingOverlay.style.display = 'none';
        submitBtn.disabled = false;
        showToast("Aucune activitÃ© dÃ©tectÃ©e. VÃ©rifiez l'URL ou rÃ©essayez.", true);
    }, 25000); // 25s

    // Hide the initial loading overlay as soon as the backend emits any progress/log
    const onFirstActivity = ()=>{
        clearTimeout(activityTimeout);
        loadingOverlay.style.display = 'none';
    };
    socket.once('progress', onFirstActivity);
    socket.once('log', onFirstActivity);

    // Ensure the submit button is re-enabled when finished or on error
    const onFinishOrError = ()=>{
        clearTimeout(activityTimeout);
        loadingOverlay.style.display = 'none';
        submitBtn.disabled = false;
    };
    socket.once('finished', onFinishOrError);
    socket.once('error', onFinishOrError);

    // fire the request; handle immediate fetch errors separately
    fetch("/process_video", {method:"POST", body:new FormData(form)})
        .catch(err=>{
            clearTimeout(activityTimeout);
            loadingOverlay.style.display = 'none';
            submitBtn.disabled = false;
            showToast('Erreur de requÃªte : ' + err, true);
        });
});

socket.on("log", msg=>{
    logs.innerHTML += `<div class="log">${msg}</div>`;
    logs.scrollTop = logs.scrollHeight;
});

socket.on("progress", data=>{
    let percent = Math.round(data.current/data.total*100);
    progressBar.style.width = percent + "%";
    logs.innerHTML += `<div class="log">ğŸ”¹ ${data.step} : ${data.current}/${data.total}</div>`;
    logs.scrollTop = logs.scrollHeight;
});

socket.on("finished", data=>{
    downloadLink.innerHTML = `<a href="/translated_videos/${data.video_file}" class="btn">TÃ©lÃ©charger la vidÃ©o doublÃ©e</a>`;
    logs.innerHTML += `<div class="log success">âœ… Traitement terminÃ© !</div>`;
    showToast('âœ… Traitement terminÃ© â€” vidÃ©o disponible');
});

socket.on("error", msg=>{
    logs.innerHTML += `<div class="log error">âš ï¸ Erreur : ${msg}</div>`;
    showToast('âš ï¸ Erreur : ' + msg, true);
});

// Le bouton de purge a Ã©tÃ© retirÃ© : le serveur supprime automatiquement les fichiers temporaires

function showToast(message, isError=false){
    toast.textContent = message;
    toast.style.background = isError ? '#c0392b' : '#2d7a2d';
    toast.style.display = 'block';
    setTimeout(()=> toast.style.display = 'none', 5000);
}
</script>
</body>
</html>
