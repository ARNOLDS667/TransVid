<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TransVid Pro - Doublage IA</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
</head>
<body>

<!-- Theme Toggle -->
<div class="theme-toggle" id="themeToggle">
    <span class="icon">ğŸŒ™</span>
</div>

<!-- Main Container -->
<div class="main-container">
    <!-- Header VidMate Style -->
    <header class="header-vidmate">
        <div class="logo-container">
            <div class="logo-circle">
                <span class="logo-icon">ğŸ¬</span>
            </div>
            <div class="logo-text">
                <h1>TransVid <span class="pro-badge-new">PRO</span></h1>
                <p class="subtitle">Doublage intelligent par IA</p>
            </div>
        </div>
    </header>

    <!-- Quick Stats Banner -->
    <div class="stats-banner">
        <div class="stat-item">
            <div class="stat-icon-circle">âš¡</div>
            <div class="stat-content">
                <span class="stat-number" id="totalProcessed">0</span>
                <span class="stat-label">VidÃ©os</span>
            </div>
        </div>
        <div class="stat-item">
            <div class="stat-icon-circle">â±ï¸</div>
            <div class="stat-content">
                <span class="stat-number" id="avgTime">--</span>
                <span class="stat-label">Temps moy.</span>
            </div>
        </div>
        <div class="stat-item">
            <div class="stat-icon-circle">ğŸ¯</div>
            <div class="stat-content">
                <span class="stat-number" id="successRate">100%</span>
                <span class="stat-label">SuccÃ¨s</span>
            </div>
        </div>
    </div>

    <!-- Main Card VidMate Style -->
    <div class="card-vidmate">
        <!-- Video Preview VidMate Style -->
        <div class="video-preview-vidmate" id="videoPreview" style="display: none;">
            <div class="preview-thumbnail">
                <img id="thumbnailImg" alt="AperÃ§u">
                <div class="preview-duration" id="previewDuration">0:00</div>
            </div>
            <div class="preview-info">
                <h3 id="videoTitle"></h3>
                <div class="preview-meta">
                    <span id="videoChannel"></span>
                    <span class="separator">â€¢</span>
                    <span id="videoViews"></span>
                </div>
            </div>
            <button class="btn-close-preview-vidmate" onclick="closePreview()">âœ•</button>
        </div>

        <!-- Form VidMate Style -->
        <form id="videoForm" class="video-form-vidmate">
            <!-- URL Input with Preview Button -->
            <div class="input-container-vidmate">
                <div class="input-icon">ğŸ”—</div>
                <input 
                    type="text" 
                    name="youtube_url" 
                    id="youtubeUrl"
                    placeholder="Coller le lien YouTube ici..." 
                    required>
                <button type="button" class="btn-inline-preview" onclick="previewVideo()">
                    ğŸ‘ï¸
                </button>
            </div>

            <!-- Options Grid VidMate Style -->
            <div class="options-container-vidmate">
                <!-- Quality Selector -->
                <div class="option-card-vidmate">
                    <div class="option-header">
                        <span class="option-icon-vidmate">ğŸ¥</span>
                        <span class="option-title">QualitÃ©</span>
                    </div>
                    <select name="quality" id="quality" class="select-vidmate">
                        <option value="best">Meilleure (1080p)</option>
                        <option value="medium" selected>Moyenne (720p) âš¡</option>
                        <option value="low">Basse (360p) ğŸš€</option>
                    </select>
                </div>

                <!-- Voice Gender Selector -->
                <div class="option-card-vidmate">
                    <div class="option-header">
                        <span class="option-icon-vidmate">ğŸ—£ï¸</span>
                        <span class="option-title">Voix</span>
                    </div>
                    <select name="voice_gender" id="voiceGender" class="select-vidmate">
                        <option value="female">FÃ©minine ğŸ‘©</option>
                        <option value="male">Masculine ğŸ‘¨</option>
                    </select>
                </div>

                <!-- Advanced Options Toggle -->
                <div class="option-card-vidmate option-card-full">
                    <div class="option-header">
                        <span class="option-icon-vidmate">âš™ï¸</span>
                        <span class="option-title">Options avancÃ©es</span>
                    </div>
                    <div class="toggle-group">
                        <label class="toggle-switch">
                            <input type="checkbox" name="use_aria2" id="useAria2">
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">TÃ©lÃ©chargement rapide (aria2)</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Big Download Button VidMate Style -->
            <button type="submit" class="btn-download-vidmate" id="submitBtn">
                <span class="btn-icon-large">â¬‡ï¸</span>
                <div class="btn-text-group">
                    <span class="btn-main-text">Lancer le doublage</span>
                    <span class="btn-sub-text">TÃ©lÃ©charger et traduire en franÃ§ais</span>
                </div>
            </button>
        </form>

        <!-- Progress Section VidMate Style -->
        <div class="progress-section-vidmate" id="progressSection" style="display: none;">
            <!-- Cancel Button -->
            <button class="btn-cancel-processing" id="btnCancel" onclick="cancelProcessing()">
                <span>ğŸ›‘</span> Annuler
            </button>

            <!-- Current Step with Animation -->
            <div class="current-step-vidmate">
                <div class="step-icon-animated" id="stepIcon">ğŸ“¥</div>
                <div class="step-info-vidmate">
                    <h3 id="stepTitle">PrÃ©paration...</h3>
                    <p id="stepMessage">Initialisation du traitement</p>
                </div>
            </div>

            <!-- Circular Progress -->
            <div class="circular-progress-container">
                <svg class="circular-progress" width="150" height="150">
                    <circle class="bg-circle" cx="75" cy="75" r="65"></circle>
                    <circle class="progress-circle" cx="75" cy="75" r="65" id="progressCircle"></circle>
                </svg>
                <div class="progress-percent-center" id="progressPercent">0%</div>
            </div>

            <!-- Progress Details -->
            <div class="progress-details-vidmate">
                <span id="progressDetails">En attente...</span>
            </div>

            <!-- Mini Steps Timeline -->
            <div class="mini-steps">
                <div class="mini-step" data-step="download">ğŸ“¥</div>
                <div class="mini-step" data-step="transcribe">ğŸ§</div>
                <div class="mini-step" data-step="translate">ğŸŒ</div>
                <div class="mini-step" data-step="voice">ğŸ—£ï¸</div>
                <div class="mini-step" data-step="merge">ğŸ¬</div>
            </div>
        </div>

        <!-- Compact Logs -->
        <div class="logs-container-vidmate" id="logsContainer" style="display: none;">
            <div class="logs-header-vidmate">
                <span>ğŸ“‹ ActivitÃ©</span>
                <button class="btn-toggle-logs" onclick="toggleLogs()">â–¼</button>
            </div>
            <div class="logs-vidmate" id="logs"></div>
        </div>

        <!-- Download Success VidMate Style -->
        <div class="success-section-vidmate" id="downloadSection" style="display: none;">
            <div class="success-icon-vidmate">
                <div class="checkmark-circle">âœ“</div>
            </div>
            <h2>VidÃ©o prÃªte ! ğŸ‰</h2>
            <p class="success-subtitle">Votre vidÃ©o doublÃ©e est disponible</p>
            
            <div id="downloadLink"></div>
            
            <div class="success-actions">
                <button class="btn-new-video" onclick="resetForm()">
                    <span>ğŸ”„</span> Nouvelle vidÃ©o
                </button>
            </div>
        </div>
    </div>

    <!-- History Section VidMate Style -->
    <div class="history-section-vidmate" id="historyCard" style="display: none;">
        <div class="section-header-vidmate">
            <h3>ğŸ“š RÃ©cents</h3>
            <button class="btn-clear-history" onclick="clearHistory()">Effacer</button>
        </div>
        <div class="history-grid-vidmate" id="historyList"></div>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container-vidmate"></div>

<script>
// ============= Configuration =============
const socket = io({
    reconnection: true,
    reconnectionDelay: 1000,
    reconnectionAttempts: 5,
    timeout: 120000
});

const form = document.getElementById('videoForm');
const submitBtn = document.getElementById('submitBtn');
const progressSection = document.getElementById('progressSection');
const downloadSection = document.getElementById('downloadSection');
const logsContainer = document.getElementById('logsContainer');
const logs = document.getElementById('logs');
const videoPreview = document.getElementById('videoPreview');

let startTime = null;
let processingHistory = JSON.parse(localStorage.getItem('transvid_history') || '[]');
let logsExpanded = false;

// ============= Theme Toggle =============
const themeToggle = document.getElementById('themeToggle');
const currentTheme = localStorage.getItem('theme') || 'dark';
document.body.classList.add(currentTheme + '-theme');
updateThemeIcon();

themeToggle.addEventListener('click', () => {
    const isLight = document.body.classList.contains('light-theme');
    document.body.classList.remove('light-theme', 'dark-theme');
    document.body.classList.add(isLight ? 'dark-theme' : 'light-theme');
    localStorage.setItem('theme', isLight ? 'dark' : 'light');
    updateThemeIcon();
});

function updateThemeIcon() {
    const icon = themeToggle.querySelector('.icon');
    icon.textContent = document.body.classList.contains('dark-theme') ? 'â˜€ï¸' : 'ğŸŒ™';
}

// ============= Video Preview =============
async function previewVideo() {
    const url = document.getElementById('youtubeUrl').value.trim();
    if (!url) {
        showToast('Veuillez entrer une URL', 'error');
        return;
    }

    showToast('Chargement...', 'info');
    
    try {
        const response = await fetch('/get_video_info', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url})
        });
        
        const data = await response.json();
        
        if (data.success) {
            const info = data.info;
            document.getElementById('thumbnailImg').src = info.thumbnail;
            document.getElementById('videoTitle').textContent = info.title;
            document.getElementById('videoChannel').textContent = info.channel;
            document.getElementById('videoViews').textContent = formatViews(info.view_count) + ' vues';
            document.getElementById('previewDuration').textContent = formatDuration(info.duration);
            videoPreview.style.display = 'flex';
            videoPreview.classList.add('fade-in');
            showToast('AperÃ§u chargÃ©', 'success');
        } else {
            showToast(data.error, 'error');
        }
    } catch (error) {
        showToast('Erreur de chargement', 'error');
    }
}

function closePreview() {
    videoPreview.style.display = 'none';
}

// ============= Form Submission =============
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    downloadSection.style.display = 'none';
    progressSection.style.display = 'block';
    logsContainer.style.display = 'block';
    logs.innerHTML = '';
    submitBtn.disabled = true;
    closePreview();
    
    startTime = Date.now();
    
    try {
        const formData = new FormData(form);
        await fetch('/process_video', {method: 'POST', body: formData});
    } catch (error) {
        showToast('Erreur: ' + error, 'error');
        submitBtn.disabled = false;
    }
});

// ============= Socket Events =============
socket.on('connect', () => {
    console.log('âœ… ConnectÃ© au serveur');
});

socket.on('disconnect', () => {
    console.log('âŒ DÃ©connectÃ© du serveur');
    showToast('Connexion perdue, reconnexion...', 'warning');
});

socket.on('log', (msg) => {
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry-vidmate';
    logEntry.innerHTML = `<span class="log-time">${getTime()}</span> ${msg}`;
    logs.appendChild(logEntry);
    logs.scrollTop = logs.scrollHeight;
});

socket.on('step_change', (data) => {
    updateCurrentStep(data.step, data.message);
});

socket.on('progress', (data) => {
    updateCircularProgress(data.percent, data.message);
    updateMiniSteps(data.step);
});

socket.on('finished', (data) => {
    const duration = ((Date.now() - startTime) / 1000 / 60).toFixed(1);
    
    progressSection.style.display = 'none';
    downloadSection.style.display = 'block';
    downloadSection.classList.add('fade-in');
    
    const fileSize = ((data.duration || 0) * 2).toFixed(0); // Estimation
    document.getElementById('downloadLink').innerHTML = 
        `<a href="/translated_videos/${data.video_file}" class="btn-download-final" download>
            <div class="download-icon-circle">â¬‡ï¸</div>
            <div class="download-info">
                <span class="download-title">TÃ©lÃ©charger la vidÃ©o</span>
                <span class="download-meta">${(data.duration || 0).toFixed(1)} min â€¢ ~${fileSize} MB</span>
            </div>
        </a>`;
    
    addToHistory({
        title: data.info?.title || 'VidÃ©o',
        duration: duration,
        timestamp: Date.now(),
        file: data.video_file,
        thumbnail: data.info?.thumbnail || ''
    });
    
    submitBtn.disabled = false;
    showToast('âœ… TerminÃ© !', 'success');
    updateStats();
});

socket.on('error', (msg) => {
    showToast('âŒ ' + msg, 'error');
    submitBtn.disabled = false;
    progressSection.style.display = 'none';
});

// ============= Progress Functions =============
function updateCurrentStep(step, message) {
    const stepData = {
        download: {icon: 'ğŸ“¥', title: 'TÃ©lÃ©chargement'},
        transcribe: {icon: 'ğŸ§', title: 'Transcription'},
        translate: {icon: 'ğŸŒ', title: 'Traduction'},
        voice: {icon: 'ğŸ—£ï¸', title: 'Doublage'},
        merge: {icon: 'ğŸ¬', title: 'Finalisation'}
    };
    
    const current = stepData[step] || {icon: 'âš™ï¸', title: 'Traitement'};
    document.getElementById('stepIcon').textContent = current.icon;
    document.getElementById('stepTitle').textContent = current.title;
    document.getElementById('stepMessage').textContent = message || '';
}

function updateCircularProgress(percent, message) {
    const circle = document.getElementById('progressCircle');
    const percentText = document.getElementById('progressPercent');
    const details = document.getElementById('progressDetails');
    
    const radius = 65;
    const circumference = 2 * Math.PI * radius;
    const offset = circumference - (percent / 100) * circumference;
    
    circle.style.strokeDasharray = `${circumference} ${circumference}`;
    circle.style.strokeDashoffset = offset;
    
    percentText.textContent = percent + '%';
    if (message) details.textContent = message;
}

function updateMiniSteps(currentStep) {
    document.querySelectorAll('.mini-step').forEach(el => {
        el.classList.remove('active');
        if (el.dataset.step === currentStep) {
            el.classList.add('active');
        }
    });
}

// ============= History Management =============
function addToHistory(item) {
    processingHistory.unshift(item);
    if (processingHistory.length > 10) processingHistory.pop();
    localStorage.setItem('transvid_history', JSON.stringify(processingHistory));
    renderHistory();
}

function renderHistory() {
    if (processingHistory.length === 0) {
        document.getElementById('historyCard').style.display = 'none';
        return;
    }
    
    document.getElementById('historyCard').style.display = 'block';
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = processingHistory.map(item => `
        <div class="history-card-vidmate">
            <div class="history-thumbnail">
                ${item.thumbnail ? `<img src="${item.thumbnail}" alt="">` : '<div class="thumbnail-placeholder">ğŸ¥</div>'}
            </div>
            <div class="history-details">
                <h4>${item.title}</h4>
                <p>${formatDate(item.timestamp)} â€¢ ${item.duration} min</p>
            </div>
        </div>
    `).join('');
}

function clearHistory() {
    if (confirm('Effacer tout l\'historique ?')) {
        processingHistory = [];
        localStorage.setItem('transvid_history', '[]');
        renderHistory();
        updateStats();
        showToast('Historique effacÃ©', 'info');
    }
}

// ============= Stats =============
function updateStats() {
    document.getElementById('totalProcessed').textContent = processingHistory.length;
    if (processingHistory.length > 0) {
        const avgTime = (processingHistory.reduce((sum, item) => 
            sum + parseFloat(item.duration), 0) / processingHistory.length).toFixed(1);
        document.getElementById('avgTime').textContent = avgTime + 'm';
    }
}

// ============= Utility Functions =============
function toggleLogs() {
    logsExpanded = !logsExpanded;
    logs.style.maxHeight = logsExpanded ? '300px' : '150px';
    document.querySelector('.btn-toggle-logs').textContent = logsExpanded ? 'â–²' : 'â–¼';
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast-vidmate toast-${type}`;
    
    const icons = {info: 'â„¹ï¸', success: 'âœ…', error: 'âŒ', warning: 'âš ï¸'};
    toast.innerHTML = `<span>${icons[type]}</span><span>${message}</span>`;
    
    container.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function resetForm() {
    downloadSection.style.display = 'none';
    progressSection.style.display = 'none';
    logsContainer.style.display = 'none';
    form.reset();
    closePreview();
}

function getTime() {
    return new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
}

function formatDuration(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function formatViews(views) {
    if (views >= 1000000) return (views / 1000000).toFixed(1) + 'M';
    if (views >= 1000) return (views / 1000).toFixed(1) + 'K';
    return views;
}

function formatDate(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffHours = (now - date) / 1000 / 3600;
    
    if (diffHours < 1) return 'Il y a ' + Math.floor(diffHours * 60) + ' min';
    if (diffHours < 24) return 'Il y a ' + Math.floor(diffHours) + 'h';
    return date.toLocaleDateString('fr-FR');
}

// ============= Initialize =============
renderHistory();
updateStats();

// DÃ©marrer avec le thÃ¨me sombre par dÃ©faut (VidMate style)
if (!localStorage.getItem('theme')) {
    document.body.classList.remove('light-theme');
    document.body.classList.add('dark-theme');
    localStorage.setItem('theme', 'dark');
    updateThemeIcon();
}
</script>

</body>
</html>